<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Gacha Wheel</title>
    <!-- CDN for Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <!-- CDN for GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- CDN for canvas-confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- CDN for Howler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <!-- CDN for Hammer.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- CDN for Particles.js -->
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <!-- Google Sans font -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Google Sans', sans-serif;
            background-color: #f0f0f0;
            color: #1e1e1e;
        }
        
        .wheel-wrapper {
            touch-action: none;
            user-select: none;
            position: relative;
            padding: 40px; /* Increased from 20px */
            border: 12px solid #4285f4;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(66, 133, 244, 0.6);
            background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(240,240,240,0.5) 100%);
            transition: all 0.3s ease;
        }
        
        .wheel-wrapper::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            z-index: -1;
            opacity: 0.5;
            filter: blur(15px);
        }
        
        .wheel {
            transform-origin: center;
            overflow: hidden;
            position: relative;
            background: white;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        .segment {
            transition: all 0.3s ease;
            transform-origin: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .segment span {
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .segment-image {
            width: 90px;
            height: 90px;
            object-fit: contain;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 6px;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            margin-bottom: 8px;
            z-index: 2;
            max-width: 100%;
            max-height: 100%;
        }
        
        .segment-label {
            font-size: 1rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-top: 8px;
            max-width: 120px;
            text-align: center;
            background-color: rgba(0,0,0,0.4);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px; /* Wider for the triangle shape */
            height: 100px; /* Shorter length */
            z-index: 20;
            transform-origin: center center;
            transform: translate(-50%, -50%);
        }
        
        .arrow-body {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000; /* Black arrow */
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); /* Triangle shape */
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        /* Remove the separate arrow head */
        .arrow-head {
            display: none;
        }
        
        .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: white;
            border: 3px solid #000000;
            border-radius: 50%;
            z-index: 25; /* Increased to be above the arrow */
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        .center-dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background-color: #000000;
            border-radius: 50%;
        }
        
        .button {
            border-radius: 24px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: 0.25px;
            text-transform: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.16);
            padding: 0.75rem 1.5rem;
        }
        
        .spin-button {
            background-color: #4285f4;
            color: white;
        }
        
        .spin-button:hover {
            background-color: #3367d6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.24);
        }
        
        .spin-button:disabled {
            background-color: #bdc1c6;
            cursor: not-allowed;
        }
        
        .dev-mode-button {
            background-color: #ea4335;
            color: white;
        }
        
        .dev-mode-button:hover {
            background-color: #d33426;
        }
        
        .glow-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(circle, rgba(66, 133, 244, 0.7) 0%, transparent 70%);
            opacity: 0;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            gap: 1.5rem;
        }
        
        .stats-box {
            background: white;
            border: 2px solid #4285f4;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }
        
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .result-card {
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
            padding: 1rem;
            max-width: 300px;
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 0.75rem 1.5rem;
            width: 100%;
        }
        
        .footer {
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            color: #5f6368;
        }

        /* Popup styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .popup-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
            position: relative;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }
        
        .popup-overlay.active .popup-content {
            transform: translateY(0);
        }
        
        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f1f3f4;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .popup-close:hover {
            background-color: #e8eaed;
        }
        
        .popup-image {
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
            object-fit: contain;
        }
        
        .popup-title {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .popup-subtitle {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .popup-rarity {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="navbar flex items-center">
        <img src="https://live.staticflickr.com/65535/54522534773_92c69b50a7_z.jpg" alt="Google Developers" height="28" width="182">
        <div class="flex-grow"></div>
        <h1 class="text-lg font-medium">Gacha Wheel</h1>
    </div>
    
    <div id="app" class="container">
        <div class="wheel-wrapper">
            <div class="wheel relative w-[600px] h-[600px] rounded-full shadow-lg" id="wheel">
                <div class="glow-effect" id="glow"></div>
                <div class="arrow" id="spinner-arrow">
                    <div class="arrow-body"></div>
                </div>
                <div class="center-dot"></div>
            </div>
        </div>
        
        <p class="text-center text-xl font-medium">Spin the Wheel of Fortune!</p>
        
        <button id="spin-button" class="button spin-button flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                <path d="M12 18l-3-3 3-3"></path>
                <path d="M8 15h8"></path>
            </svg>
            Spin Now!
        </button>
        
        <div id="motivation" class="text-center text-gray-700 max-w-xs"></div>
    </div>
    
    <!-- Result Popup -->
    <div class="popup-overlay" id="result-popup">
        <div class="popup-content">
            <div class="popup-close" id="popup-close">✕</div>
            <img src="" alt="" class="popup-image" id="popup-image">
            <div class="popup-title" id="popup-title"></div>
            <div class="popup-subtitle" id="popup-subtitle"></div>
            <div class="popup-rarity" id="popup-rarity"></div>
        </div>
    </div>
    
    <div class="footer">
        © 2025 Google Developer Groups on Campus
    </div>

    <script>
        // Initialize Particles.js with Google-themed colors
        particlesJS('particles-js', {
            particles: {
                number: { value: 50, density: { enable: true, value_area: 800 } },
                color: { value: ['#4285f4', '#34a853', '#fbbc05', '#ea4335'] },
                shape: { type: 'circle', stroke: { width: 0, color: '#000000' } },
                opacity: { value: 0.3, random: true },
                size: { value: 4, random: true },
                line_linked: { enable: false },
                move: {
                    enable: true,
                    speed: 1.5,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'repulse' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                }
            },
            retina_detect: true
        });

        // Rarity configuration with Google colors - simplified
        const RARITIES = {
            SSR: { rate: 0.5, color: '#f8f9fa', textColor: '#202124', name: 'SSR' }, // White
            SR: { rate: 0.2, color: '#f8f9fa', textColor: '#202124', name: 'SR' }, // White
            R: { rate: 0.2, color: '#f8f9fa', textColor: '#202124', name: 'R' }, // White
            COMMON: { rate: 99, color: '#f8f9fa', textColor: '#202124', name: 'COMMON' }, // White
            LOSE: { rate: 0.1, color: '#f8f9fa', textColor: '#202124', name: 'LOSE' } // White
        };

        // Prize list with Google products - reordered to put stickers at top
        const items = [
            { 
                label: 'GDG Stickers', 
                rarity: 'COMMON', 
                image: 'Sticker2.png'
            },
            { 
                label: 'Google Pixel 8', 
                rarity: 'SSR', 
                image: 'https://t-mobile.scene7.com/is/image/Tmusprod/Google-Pixel-9a-Iris-frontimage_v2'
            },
            { 
                label: 'Google Nest Hub', 
                rarity: 'SR', 
                image: 'https://lh3.googleusercontent.com/uQZNPuGyf7dKvtGZWjoiyGcPg_A44yUS2tx-o2--dyuwp9A1vR4Efh1UF28KKLpGUg=w895'
            },
            { 
                label: 'Pixel Buds Pro', 
                rarity: 'R', 
                image: 'https://images.tokopedia.net/img/cache/700/hDjmkQ/2022/10/4/7082ea6a-cd78-4302-87be-7575316b948d.jpg'
            },
            { 
                label: 'Pixel Watch', 
                rarity: 'R', 
                image: 'https://cdn.idntimes.com/content-images/post/20231006/hero-pixel-watch-2width-1000format-webp-3714233e689ae5e3d3cf12c966ec032c_600x400.jpg'
            },
            { 
                label: 'Nothing', 
                rarity: 'LOSE', 
                image: 'https://developers.google.com/site-assets/images/home/developers-logo-color.svg'
            }
        ];

        let spinning = false;
        let deg = 0;
        let wheel = document.getElementById('wheel');
        let winner = null;
        let spinSound, winSound, nearMissSound, loseSound;
        let hammer = null;

        // Motivation messages with Google-themed text
        const MOTIVATION_MESSAGES = [
            "Almost got the grand prize! Try again!",
            "Your next spin could be lucky!",
            "One more spin for a legendary prize!",
            "Fortune is smiling on you!",
            "The grand prize is within reach!"
        ];

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Handle image errors
            const handleImageError = (img) => {
                img.onerror = null; // Prevent infinite loops
                if (img.src.includes('i.imgur.com')) {
                    // Fallback for imgur images
                    img.src = 'Sticker2.png';
                    console.log('Using fallback image for stickers');
                }
            };
            
            // Update the sticker image if needed
            const stickerItem = items.find(item => item.label === 'GDG Stickers');
            if (stickerItem) {
                const testImg = new Image();
                testImg.onerror = () => {
                    stickerItem.image = 'Sticker2.png';
                    console.log('Updated sticker image to fallback URL');
                };
                testImg.src = stickerItem.image;
            }
            
            initializeSounds();
            setupWheel();
            setupHammerJS();
            document.getElementById('spin-button').addEventListener('click', () => spinWheel(4));
            
            // Close popup when clicking outside
            document.getElementById('result-popup').addEventListener('click', (e) => {
                if (e.target === document.getElementById('result-popup')) {
                    document.getElementById('result-popup').classList.remove('active');
                }
            });
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (hammer) hammer.destroy();
        });

        function initializeSounds() {
            try {
                // Use real sound URLs from freesound.org
                spinSound = new Howl({ 
                    src: ['https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=wheel-spin-6320.mp3'], 
                    volume: 0.5,
                    html5: true
                });
                winSound = new Howl({ 
                    src: ['https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3?filename=success-1-6297.mp3'], 
                    volume: 0.5,
                    html5: true
                });
                nearMissSound = new Howl({ 
                    src: ['https://cdn.pixabay.com/download/audio/2022/11/21/audio_00fc05c666.mp3?filename=click-menu-app-147357.mp3'], 
                    volume: 0.7,
                    html5: true
                });
                loseSound = new Howl({ 
                    src: ['https://cdn.pixabay.com/download/audio/2022/03/15/audio_942b7c4f74.mp3?filename=negative_beeps-6008.mp3'], 
                    volume: 0.6,
                    html5: true
                });
            } catch (error) {
                console.error('Error initializing sounds:', error);
            }
        }

        function setupWheel() {
            wheel.innerHTML = '<div class="glow-effect" id="glow"></div><div class="arrow" id="spinner-arrow"><div class="arrow-body"></div></div><div class="center-dot"></div>';
            const sliceAngle = 360 / items.length;
            
            // Calculate optimal positioning based on number of items
            const distanceFromCenter = items.length <= 6 ? 180 : 150;
            const imageSize = items.length <= 6 ? 100 : 80; // Increased image size
            
            // First create all segments
            items.forEach((item, i) => {
                const segment = document.createElement('div');
                segment.className = `segment absolute w-full h-full`;
                segment.style.transform = `rotate(${i * sliceAngle}deg)`;
                segment.style.clipPath = `path('M 300 300 L 300 0 A 300 300 0 0 1 ${300 + 300 * Math.cos(sliceAngle * Math.PI / 180)} ${300 - 300 * Math.sin(sliceAngle * Math.PI / 180)} Z')`;
                
                // Create uniform white background for all segments
                segment.style.backgroundColor = '#f8f9fa';
                
                // Add subtle borders between segments
                segment.style.border = '1px solid rgba(0,0,0,0.1)';
                
                // Add a small colored indicator based on rarity
                const indicator = document.createElement('div');
                indicator.style.position = 'absolute';
                indicator.style.top = '20px';
                indicator.style.left = '300px';
                indicator.style.width = '20px';
                indicator.style.height = '20px';
                indicator.style.borderRadius = '50%';
                
                // Use Google colors for the indicators
                switch(item.rarity) {
                    case 'SSR': indicator.style.backgroundColor = '#4285f4'; break; // Blue
                    case 'SR': indicator.style.backgroundColor = '#ea4335'; break;  // Red
                    case 'R': indicator.style.backgroundColor = '#34a853'; break;   // Green
                    case 'COMMON': indicator.style.backgroundColor = '#fbbc05'; break; // Yellow
                    case 'LOSE': indicator.style.backgroundColor = '#bdc1c6'; break; // Gray
                }
                
                segment.appendChild(indicator);
                wheel.appendChild(segment);
            });
            
            // Then add content to each segment (separate loop to ensure proper z-index stacking)
            items.forEach((item, i) => {
                // Find the colored dot position for this segment
                const dotAngle = i * sliceAngle;
                const dotRadians = dotAngle * Math.PI / 180;
                
                // Create content container with improved positioning
                const content = document.createElement('div');
                content.className = 'absolute flex items-center justify-center';
                content.dataset.rarity = item.rarity;
                content.dataset.index = i;
                
                // Position at the colored dot location
                const dotDistance = 250; // Reduced distance from center to the colored dot
                const posX = Math.sin(dotRadians) * dotDistance;
                const posY = -Math.cos(dotRadians) * dotDistance;
                
                content.style.transform = `translate(-50%, -50%)`; // No rotation
                content.style.left = `calc(50% + ${posX}px)`;
                content.style.top = `calc(50% + ${posY}px)`;
                content.style.width = `${imageSize}px`;
                content.style.height = `${imageSize}px`;
                content.style.zIndex = '10';
                
                // Create image container with improved styling for clarity
                const imgContainer = document.createElement('div');
                imgContainer.className = 'flex items-center justify-center rounded-lg overflow-hidden';
                imgContainer.style.width = '100%';
                imgContainer.style.height = '100%';
                imgContainer.style.backgroundColor = 'rgba(255,255,255,0.95)';
                imgContainer.style.borderRadius = '8px';
                imgContainer.style.padding = '4px';
                imgContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
                imgContainer.style.position = 'relative';
                imgContainer.style.zIndex = '15';
                
                // Create image element with better styling
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.label;
                img.style.objectFit = 'contain';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.transition = 'transform 0.3s ease';
                img.style.display = 'block';
                
                // Preload image to ensure it displays
                const preloadImg = new Image();
                preloadImg.onload = function() {
                    img.src = this.src;
                };
                preloadImg.onerror = function() {
                    console.log(`Error preloading image for ${item.label}, using fallback`);
                    if (item.label === 'GDG Stickers') {
                        img.src = 'https://i.ibb.co/TqnYdnG3/Sticker2.png';
                    }
                };
                preloadImg.src = item.image;
                
                // Special handling for the custom sticker image
                if (item.label === 'GDG Stickers') {
                    img.style.background = 'transparent';
                }
                
                imgContainer.appendChild(img);
                
                // No label text or rarity badge
                
                content.appendChild(imgContainer);
                wheel.appendChild(content);
            });
        }

        function setupHammerJS() {
            if (!wheel) return;
            hammer = new Hammer(wheel);
            hammer.get('swipe').set({ direction: Hammer.DIRECTION_ALL });
            hammer.on('swipeup swipedown', (e) => {
                if (!spinning) {
                    const swipeVelocity = Math.abs(e.velocity);
                    const duration = Math.max(2, Math.min(6, 7 - swipeVelocity));
                    spinWheel(duration);
                }
            });
        }

        function getRandomRarity() {
            // This function is no longer used for actual selection,
            // but we keep it for compatibility with other code
            return "COMMON";
        }

        function getItemByRarity(rarity) {
            const availableItems = items.filter(item => item.rarity === rarity);
            return availableItems[Math.floor(Math.random() * availableItems.length)] || items[items.length - 1];
        }

        function getNearMissRarity(targetRarity) {
            const rarityOrder = ['SSR', 'SR', 'R', 'COMMON', 'LOSE'];
            const currentIndex = rarityOrder.indexOf(targetRarity);
            const higherRarities = rarityOrder.slice(0, currentIndex).filter(r => r !== 'LOSE');
            if (higherRarities.length === 0) return null;
            return higherRarities[Math.floor(Math.random() * higherRarities.length)];
        }

        function spinWheel(spinDuration) {
            if (spinning || !wheel) return;
            spinning = true;
            document.getElementById('spin-button').disabled = true;

            // Add spinning glow effect
            gsap.to('.wheel-wrapper', {
                boxShadow: '0 0 40px rgba(66, 133, 244, 0.8)',
                duration: 0.5
            });

            // Always select the COMMON item (sticker)
            const targetRarity = "COMMON";
            winner = getItemByRarity(targetRarity);

            const winnerIndex = items.findIndex(item =>
                item.label === winner.label && item.rarity === winner.rarity
            );

            if (winnerIndex === -1) {
                console.error('Winner item not found in items array');
                spinning = false;
                document.getElementById('spin-button').disabled = false;
                return;
            }

            // Use longer duration for more suspense - 8 seconds instead of 4
            animateArrow(winnerIndex, 8, targetRarity);
        }

        function animateArrow(index, duration, targetRarity) {
            const sliceAngle = 360 / items.length;
            // Calculate exact angle to point to the sticker
            const targetAngle = index * sliceAngle;
            const randomOffset = Math.random() * (sliceAngle * 0.3); // Smaller offset for more precision
            const baseRotation = 360 * (10 + Math.floor(Math.random() * 5)); // Increased from 5 to 10-15 rotations
            const finalAngle = baseRotation + targetAngle + randomOffset;

            const arrow = document.getElementById('spinner-arrow');
            let currentRotation = 0; // Start at 0 degrees (pointing up)

            if (spinSound) spinSound.play();

            const timeline = gsap.timeline({
                onComplete: () => {
                    spinning = false;
                    document.getElementById('spin-button').disabled = false;
                    
                    // Reset wheel wrapper glow
                    gsap.to('.wheel-wrapper', {
                        boxShadow: '0 0 30px rgba(66, 133, 244, 0.6)',
                        duration: 0.5
                    });
                    
                    if (winner.rarity === 'LOSE') {
                        if (loseSound) loseSound.play();
                    } else if (winner.rarity === 'SSR') {
                        if (winSound) winSound.play();
                    } else {
                        if (nearMissSound) nearMissSound.play();
                    }
                    highlightWinner(index);
                    if (winner.rarity !== 'LOSE') {
                        launchConfetti(winner.rarity);
                    }
                    showWinner();
                    showMotivation();
                }
            });

            // Add some fake suspense with near misses
            const hasNearMiss = Math.random() < 0.8; // Increased to 80% chance for more suspense
            if (hasNearMiss) {
                // Find a non-COMMON item for near miss
                const nonCommonIndices = items
                    .map((item, i) => item.rarity !== 'COMMON' ? i : -1)
                    .filter(i => i !== -1);
                
                if (nonCommonIndices.length > 0) {
                    // Pick a random non-COMMON item
                    const nearMissIndex = nonCommonIndices[Math.floor(Math.random() * nonCommonIndices.length)];
                    const nearMissAngle = nearMissIndex * sliceAngle;

                    // Create more dramatic near misses with multiple slowdowns
                    timeline
                        .to(arrow, {
                            rotation: baseRotation * 0.6, // First fast part
                            duration: duration * 0.4,
                            ease: 'power2.out'
                        })
                        .to(arrow, {
                            rotation: baseRotation * 0.8 + nearMissAngle - (sliceAngle * 0.3),
                            duration: duration * 0.3,
                            ease: 'power1.inOut'
                        })
                        .to(arrow, {
                            rotation: baseRotation * 0.8 + nearMissAngle + (sliceAngle * 0.3),
                            duration: duration * 0.15,
                            ease: 'power1.inOut'
                        });
                    
                    // Add a second near miss for more drama
                    const secondMissIndex = nonCommonIndices[(nonCommonIndices.indexOf(nearMissIndex) + 1) % nonCommonIndices.length];
                    const secondMissAngle = secondMissIndex * sliceAngle;
                    
                    timeline
                        .to(arrow, {
                            rotation: baseRotation * 0.9 + secondMissAngle - (sliceAngle * 0.2),
                            duration: duration * 0.1,
                            ease: 'power1.inOut'
                        })
                        .to(arrow, {
                            rotation: finalAngle,
                            duration: duration * 0.05,
                            ease: 'power3.out'
                        });
                } else {
                    // Just spin directly if no non-COMMON items
                    timeline.to(arrow, {
                        rotation: finalAngle,
                        duration: duration * 1.5, // Longer duration
                        ease: 'power4.out'
                    });
                }
            } else {
                // Without near-miss, spin directly but with longer duration
                timeline.to(arrow, {
                    rotation: finalAngle,
                    duration: duration * 1.5, // Longer duration
                    ease: 'power4.out'
                });
            }
            
            // Add wobble effect at the end
            timeline.to(arrow, {
                rotation: `+=${Math.random() * 3 - 1.5}`,
                duration: 0.15,
                ease: 'power1.inOut',
                delay: duration - 0.15
            });
        }

        function highlightWinner(index) {
            const segments = wheel?.querySelectorAll('.segment') || [];
            segments.forEach((el, i) => {
                el.classList.remove('ring-4', 'ring-blue-500');
                if (i === index) {
                    el.classList.add('ring-4', 'ring-blue-500');
                    gsap.fromTo(el, 
                        { filter: 'brightness(1)' }, 
                        { filter: 'brightness(1.1)', duration: 0.3, yoyo: true, repeat: 3 }
                    );
                    
                    // Find the corresponding content for this segment
                    const contents = wheel?.querySelectorAll('.flex.items-center.justify-center') || [];
                    if (contents[i]) {
                        const img = contents[i].querySelector('img');
                        if (img) {
                            gsap.fromTo(img, 
                                { scale: 1 }, 
                                { scale: 1.2, duration: 0.3, yoyo: true, repeat: 3 }
                            );
                        }
                    }
                }
            });
            
            // Make the arrow pulse instead of bounce
            gsap.fromTo('.arrow-body', 
                { scale: 1, opacity: 0.8 }, 
                { scale: 1.2, opacity: 1, duration: 0.3, yoyo: true, repeat: 5 }
            );
        }

        function launchConfetti(rarity) {
            // Google colors
            const colors = ['#4285f4', '#34a853', '#fbbc05', '#ea4335'];

            confetti({
                particleCount: rarity === 'SSR' ? 300 : 150,
                spread: 90,
                origin: { y: 0.6 },
                colors: colors,
                shapes: rarity === 'SSR' ? ['star', 'circle'] : ['circle'],
                disableForReducedMotion: true
            });
        }

        function showWinner() {
            if (!winner) return;

            // Get popup elements
            const popup = document.getElementById('result-popup');
            const popupImage = document.getElementById('popup-image');
            const popupTitle = document.getElementById('popup-title');
            const popupSubtitle = document.getElementById('popup-subtitle');
            const popupRarity = document.getElementById('popup-rarity');
            
            // Set popup content
            popupImage.src = winner.image;
            popupImage.alt = winner.label;
            popupImage.style.maxWidth = '150px';
            popupImage.style.maxHeight = '150px';
            popupImage.style.objectFit = 'contain';
            popupImage.style.filter = 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))';
            
            // Handle image errors
            popupImage.onerror = () => {
                console.log(`Error loading popup image for ${winner.label}, using fallback`);
                if (winner.label === 'GDG Stickers') {
                    popupImage.src = 'https://i.ibb.co/TqnYdnG3/Sticker2.png';
                }
            };
            
            // Special handling for custom sticker image in popup
            if (winner.label === 'GDG Stickers') {
                popupImage.style.maxWidth = '200px';
                popupImage.style.maxHeight = '200px';
                popupImage.style.background = 'transparent';
            }
            
            if (winner.rarity === 'LOSE') {
                popupTitle.textContent = 'Sorry!';
                popupSubtitle.textContent = 'No prize this time';
            } else {
                popupTitle.textContent = winner.rarity === 'SSR' ? 'Congratulations!' : 'Better luck next time!';
                popupSubtitle.textContent = `You got: ${winner.label}`;
            }
            
            // Set rarity badge
            popupRarity.textContent = RARITIES[winner.rarity].name;
            popupRarity.style.backgroundColor = RARITIES[winner.rarity].color;
            popupRarity.style.color = RARITIES[winner.rarity].textColor;
            
            // Show the popup with a slight delay to ensure animations complete
            setTimeout(() => {
                popup.classList.add('active');
            }, 500);
            
            // Only show celebration for SSR (winning) items
            if (winner.rarity === 'SSR') {
                // Add pulse effect for winners
                gsap.to('.popup-content', {
                    boxShadow: '0 0 30px rgba(66, 133, 244, 0.8)',
                    duration: 1,
                    repeat: 2,
                    yoyo: true
                });
                
                // Add confetti inside the popup
                setTimeout(() => {
                    const popupRect = document.querySelector('.popup-content').getBoundingClientRect();
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { 
                            x: (popupRect.left + popupRect.width/2) / window.innerWidth,
                            y: (popupRect.top + popupRect.height/3) / window.innerHeight
                        },
                        colors: ['#4285f4', '#34a853', '#fbbc05', '#ea4335'],
                        disableForReducedMotion: true
                    });
                }, 600);
            }
            
            // Add close button functionality
            document.getElementById('popup-close').addEventListener('click', () => {
                popup.classList.remove('active');
            });
        }

        function showMotivation() {
            const motivationDiv = document.getElementById('motivation');
            if (winner.rarity === 'SSR') {
                motivationDiv.textContent = "Amazing! You won the GDG Swag Pack!";
            } else {
                motivationDiv.textContent = MOTIVATION_MESSAGES[Math.floor(Math.random() * MOTIVATION_MESSAGES.length)];
            }
        }
    </script>
</body>
</html>
